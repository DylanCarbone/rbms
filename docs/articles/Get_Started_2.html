<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2. Get started with rbms - collate index â€¢ rbms</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="2. Get started with rbms - collate index">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rbms</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Get_Started_1.html">1. Get started with rbms - phenology</a>
    </li>
    <li>
      <a href="../articles/Get_Started_2.html">2. Get started with rbms - collate index</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>2. Get started with rbms - collate index</h1>
            <h3 class="subtitle">Imputing missing counts</h3>
                        <h4 class="author">Reto Schmucki (UKCEH)</h4>
            
            <h4 class="date">28 November 2019</h4>
      
      
      <div class="hidden name"><code>Get_Started_2.Rmd</code></div>

    </div>

    
    
<hr>
<p>From the flight curve and the observed count, we can derive expected values for weeks or days where a site has not been monitored. Together, observed and imputed counts will then be used to compute an abundance index for each site. Site indices can then be use to calculate annual collated indices.</p>
<blockquote>
<p>see 1. Get started with rbms to compute the flight curve object used below (Step 1, 2 and 3)</p>
</blockquote>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(data.table)</a></code></pre></div>
<pre><code>## Warning: package 'data.table' was built under R version 3.6.1</code></pre>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(rbms)</a></code></pre></div>
<pre><code>##  Welcome to rbms, version 1.0.0 
##  While this package has been tested by several users,
##  it is still in active development and feedbacks are welcome 
##  https://github.com/RetoSchmucki/rbms/issues</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(m_visit)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(m_count)</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">ts_date &lt;-<span class="st"> </span>rbms<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/rbms/man/ts_dwmy_table.html">ts_dwmy_table</a></span>(<span class="dt">InitYear =</span> <span class="dv">2000</span>, <span class="dt">LastYear =</span> <span class="dv">2003</span>, <span class="dt">WeekDay1 =</span> <span class="st">'monday'</span>)</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">ts_season &lt;-<span class="st"> </span>rbms<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/rbms/man/ts_monit_season.html">ts_monit_season</a></span>(ts_date, <span class="dt">StartMonth =</span> <span class="dv">4</span>, <span class="dt">EndMonth =</span> <span class="dv">9</span>, <span class="dt">StartDay =</span> <span class="dv">1</span>, <span class="dt">EndDay =</span> <span class="ot">NULL</span>, <span class="dt">CompltSeason =</span> <span class="ot">TRUE</span>, <span class="dt">Anchor =</span> <span class="ot">TRUE</span>, <span class="dt">AnchorLength =</span> <span class="dv">2</span>, <span class="dt">AnchorLag =</span> <span class="dv">2</span>, <span class="dt">TimeUnit =</span> <span class="st">'w'</span>)</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">ts_season_visit &lt;-<span class="st"> </span>rbms<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/rbms/man/ts_monit_site.html">ts_monit_site</a></span>(m_visit, ts_season)</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">ts_season_count &lt;-<span class="st"> </span>rbms<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/rbms/man/ts_monit_count_site.html">ts_monit_count_site</a></span>(ts_season_visit, m_count, <span class="dt">sp =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">ts_flight_curve &lt;-<span class="st"> </span>rbms<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/rbms/man/flight_curve.html">flight_curve</a></span>(ts_season_count, <span class="dt">NbrSample =</span> <span class="dv">300</span>, <span class="dt">MinVisit =</span> <span class="dv">5</span>, <span class="dt">MinOccur =</span> <span class="dv">3</span>, <span class="dt">MinNbrSite =</span> <span class="dv">5</span>, <span class="dt">MaxTrial =</span> <span class="dv">4</span>, <span class="dt">GamFamily =</span> <span class="st">'nb'</span>, <span class="dt">SpeedGam =</span> <span class="ot">FALSE</span>, <span class="dt">CompltSeason =</span> <span class="ot">TRUE</span>, <span class="dt">SelectYear =</span> <span class="ot">NULL</span>, <span class="dt">TimeUnit =</span> <span class="st">'w'</span>)</a></code></pre></div>
<pre><code>## [1] "Fitting the flight curve spline for species 2 and year 2000 with 76 sites, using gam() : 2019-12-10 12:21:31 -&gt; trial 1"
## [1] "Fitting the flight curve spline for species 2 and year 2001 with 76 sites, using gam() : 2019-12-10 12:21:33 -&gt; trial 1"
## [1] "Fitting the flight curve spline for species 2 and year 2002 with 88 sites, using gam() : 2019-12-10 12:21:33 -&gt; trial 1"
## [1] "Fitting the flight curve spline for species 2 and year 2003 with 103 sites, using gam() : 2019-12-10 12:21:35 -&gt; trial 1"</code></pre>
<div id="impute-predicted-counts-for-missing-monitoring-dates" class="section level5">
<h5 class="hasAnchor">
<a href="#impute-predicted-counts-for-missing-monitoring-dates" class="anchor"></a>4. Impute predicted counts for missing monitoring dates</h5>
<p>The <code><a href="../reference/impute_count.html">impute_count()</a></code> function is using the count data generated from the <code>ts_season_count()</code> function and the outcome of the <code><a href="../reference/flight_curve.html">flight_curve()</a></code> function to and the calculated flight curve (ts_flight_curve$pheno). To estimate value of missing week, the function will look for the phenology from the nearest year, the extent of the search can be limited by setting the parameter <code>YearLimit</code> parameter which by default is not restricted. Like in the previous function, the imputation can be made on a weekly or daily basis (<code>'w'</code> or <code>'d'</code>).</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="co">## extract phenology data from the ts_fligh_curve list</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2">pheno &lt;-<span class="st"> </span>ts_flight_curve<span class="op">$</span>pheno</a>
<a class="sourceLine" id="cb7-3" data-line-number="3"></a>
<a class="sourceLine" id="cb7-4" data-line-number="4">impt_counts &lt;-<span class="st"> </span>rbms<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/rbms/man/impute_count.html">impute_count</a></span>(<span class="dt">ts_season_count=</span>ts_season_count, <span class="dt">ts_flight_curve=</span>pheno, <span class="dt">YearLimit=</span> <span class="ot">NULL</span>, <span class="dt">TimeUnit=</span><span class="st">'w'</span>)</a></code></pre></div>
<p>The <code><a href="../reference/impute_count.html">impute_count()</a></code> function produces a <code>data.table</code> that contains the original <code>COUNT</code> values, a series of <code>IMPUTED_COUNT</code> over monitoring season, <code>TOTAL_COUNT</code> per site and year, <code>TOTAL_NM</code> which is the proportion of the flight curve covered by the visits, the <code>SINDEX</code> which is the site index and correspond to the sum of both observed and imputed counts over the sampling season.</p>
<p>If the flight curve of a year is missing, the <code><a href="../reference/impute_count.html">impute_count()</a></code> function will look and use the nearest phenology found. If none is found within the limit of years set by the <code>YearLimit</code> parameter, the function will compute no <code>SINDEX</code> for that specific year.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">impt_counts_1year &lt;-<span class="st"> </span>rbms<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/rbms/man/impute_count.html">impute_count</a></span>(<span class="dt">ts_season_count=</span>ts_season_count, <span class="dt">ts_flight_curve=</span>pheno[M_YEAR <span class="op">!=</span><span class="st"> </span><span class="dv">2001</span>, ], <span class="dt">YearLimit=</span> <span class="dv">1</span>, <span class="dt">TimeUnit=</span><span class="st">'w'</span>)</a></code></pre></div>
<pre><code>## Warning in FUN(X[[i]], ...): We used the flight curve of 2000 to compute
## abundance indices for year 2001</code></pre>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">impt_counts_0year &lt;-<span class="st"> </span>rbms<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/rbms/man/impute_count.html">impute_count</a></span>(<span class="dt">ts_season_count=</span>ts_season_count, <span class="dt">ts_flight_curve=</span>pheno[M_YEAR <span class="op">!=</span><span class="st"> </span><span class="dv">2001</span>, ], <span class="dt">YearLimit=</span> <span class="dv">0</span>, <span class="dt">TimeUnit=</span><span class="st">'w'</span>)</a></code></pre></div>
<pre><code>## [1] "No reliable flight curve available within a  0  year horizon of 2001"</code></pre>
</div>
<div id="site-and-collated-indices" class="section level5">
<h5 class="hasAnchor">
<a href="#site-and-collated-indices" class="anchor"></a>5 Site and collated indices</h5>
<p>From the imputed count, site index can be extracted with a filter that will only keep the indices that have been monitored of a minimum proportion of the flight curve. Here we set this threshold to a minimum value of 10% with the <code>MinFC</code> parameter.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">sindex &lt;-<span class="st"> </span>rbms<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/rbms/man/site_index.html">site_index</a></span>(<span class="dt">butterfly_count =</span> impt_counts, <span class="dt">MinFC =</span> <span class="fl">0.10</span>)</a></code></pre></div>
<p>Using the site indices, annual collated indices can be calculated by fitting a Generalized Linear Model (GLM), where sites and years are set as factors. Here we use the proportion of the flight curve sampled by the observation as a weight for the GLM. To facilitate the fit, we can remove all site where the species was not observed by setting the parameter <code>rm_zero = TRUE</code>. The collated index computed by the <code><a href="../reference/collated_index.html">collated_index()</a></code> function corresponds to the mean total butterfly count expected on a BMS transect in a given year.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">co_index &lt;-<span class="st"> </span><span class="kw"><a href="../reference/collated_index.html">collated_index</a></span>(<span class="dt">data =</span> sindex, <span class="dt">s_sp =</span> <span class="dv">2</span>, <span class="dt">sindex_value =</span> <span class="st">"SINDEX"</span>, <span class="dt">glm_weights =</span> <span class="ot">TRUE</span>, <span class="dt">rm_zero =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p>The collated index computed by the <code><a href="../reference/collated_index.html">collated_index()</a></code> function corresponds to the mean total butterfly count expected on a BMS transect in a given year.</p>
<pre><code>## $col_index
##    BOOTi M_YEAR NSITE NSITE_OBS COL_INDEX
## 1:     0   2000   124       108  19.23040
## 2:     0   2001   108       100  31.12038
## 3:     0   2002   114       107  31.13623
## 4:     0   2003   122       113  61.25559
## 
## $site_id
##   [1] "1"   "14"  "157" "158" "159" "160" "161" "162" "163" "164" "165"
##  [12] "166" "15"  "167" "168" "169" "170" "171" "172" "173" "174" "175"
##  [23] "176" "16"  "177" "178" "179" "185" "193" "51"  "82"  "31"  "41" 
##  [34] "154" "19"  "180" "181" "182" "187" "183" "184" "186" "21"  "23" 
##  [45] "24"  "25"  "26"  "27"  "2"   "28"  "29"  "30"  "32"  "34"  "36" 
##  [56] "37"  "39"  "42"  "43"  "3"   "45"  "47"  "48"  "54"  "60"  "61" 
##  [67] "62"  "64"  "65"  "69"  "4"   "71"  "72"  "76"  "83"  "84"  "85" 
##  [78] "86"  "89"  "91"  "92"  "6"   "93"  "95"  "96"  "97"  "99"  "100"
##  [89] "101" "102" "104" "106" "8"   "107" "111" "112" "113" "115" "116"
## [100] "117" "118" "119" "120" "9"   "122" "123" "124" "126" "127" "128"
## [111] "129" "130" "132" "133" "10"  "134" "135" "136" "137" "139" "140"
## [122] "141" "142" "143" "144" "12"  "145" "146" "147" "148" "149" "150"
## [133] "151" "153" "155" "156"</code></pre>
<p>This number can then be rescaled on a log(10) scale</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">co_index &lt;-<span class="st"> </span>co_index<span class="op">$</span>col_index</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">co_index_b &lt;-<span class="st"> </span>co_index[COL_INDEX <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.0001</span> <span class="op">&amp;</span><span class="st"> </span>COL_INDEX <span class="op">&lt;</span><span class="st"> </span><span class="dv">100000</span>, ]</a>
<a class="sourceLine" id="cb15-3" data-line-number="3">co_index_logInd &lt;-<span class="st"> </span>co_index_b[BOOTi <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, .(M_YEAR, COL_INDEX)][, <span class="kw"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(COL_INDEX)<span class="op">/</span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="dv">10</span>), by =<span class="st"> </span>M_YEAR][, mean_logInd <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(V1)]</a>
<a class="sourceLine" id="cb15-4" data-line-number="4"></a>
<a class="sourceLine" id="cb15-5" data-line-number="5"><span class="co">## merge the mean log index with the full bootstrap dataset</span></a>
<a class="sourceLine" id="cb15-6" data-line-number="6">data.table<span class="op">::</span><span class="kw">setnames</span>(co_index_logInd, <span class="st">"V1"</span>, <span class="st">"logInd"</span>); <span class="kw"><a href="https://rdrr.io/pkg/data.table/man/setkey.html">setkey</a></span>(co_index_logInd, M_YEAR); <span class="kw"><a href="https://rdrr.io/pkg/data.table/man/setkey.html">setkey</a></span>(co_index_b, M_YEAR)</a>
<a class="sourceLine" id="cb15-7" data-line-number="7">co_index_b &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/merge.html">merge</a></span>(co_index_b, co_index_logInd, <span class="dt">all.x =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p>This log scaled indices can then be plotted with the following code, where the average is centred on 2.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">col_pal &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"cyan4"</span>, <span class="st">"orange"</span>, <span class="st">"orangered2"</span>)</a>
<a class="sourceLine" id="cb16-2" data-line-number="2"></a>
<a class="sourceLine" id="cb16-3" data-line-number="3"><span class="co">## compute the metric used for the graph of the Collated Log-Index centered around 2 (observed, bootstap sampel, credible confidence interval, linear trend)</span></a>
<a class="sourceLine" id="cb16-4" data-line-number="4">b1 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/data.table.html">data.table</a></span>(<span class="dt">M_YEAR =</span> co_index_b<span class="op">$</span>M_YEAR, <span class="dt">LCI =</span> <span class="dv">2</span> <span class="op">+</span><span class="st"> </span>co_index_b<span class="op">$</span>logInd <span class="op">-</span><span class="st"> </span>co_index_b<span class="op">$</span>mean_logInd)</a>
<a class="sourceLine" id="cb16-5" data-line-number="5">b2 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/data.table.html">data.table</a></span>(<span class="dt">M_YEAR =</span> co_index_b[BOOTi <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, M_YEAR], <span class="dt">LCI=</span> <span class="dv">2</span> <span class="op">+</span><span class="st"> </span>co_index_b[BOOTi <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, logInd] <span class="op">-</span><span class="st"> </span>co_index_b[BOOTi <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, mean_logInd])</a>
<a class="sourceLine" id="cb16-6" data-line-number="6"></a>
<a class="sourceLine" id="cb16-7" data-line-number="7">lm_mod &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(LCI <span class="op">~</span><span class="st"> </span>M_YEAR, <span class="dt">data =</span> b2), <span class="dt">silent=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb16-8" data-line-number="8"></a>
<a class="sourceLine" id="cb16-9" data-line-number="9"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(b1, <span class="dt">col =</span> <span class="kw"><a href="https://rdrr.io/r/grDevices/adjustcolor.html">adjustcolor</a></span>( <span class="st">"cyan4"</span>, <span class="dt">alpha.f =</span> <span class="fl">0.2</span>),</a>
<a class="sourceLine" id="cb16-10" data-line-number="10">      <span class="dt">xlab =</span> <span class="st">"year"</span>, <span class="dt">ylab =</span> <span class="kw"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="st">'log '</span>[<span class="st">'(10)'</span>]<span class="op">*</span><span class="st">' Collated Index'</span>),</a>
<a class="sourceLine" id="cb16-11" data-line-number="11">      <span class="dt">xaxt=</span><span class="st">"n"</span>, <span class="dt">type =</span> <span class="st">'n'</span>)</a>
<a class="sourceLine" id="cb16-12" data-line-number="12"></a>
<a class="sourceLine" id="cb16-13" data-line-number="13"><span class="kw"><a href="https://rdrr.io/r/graphics/axis.html">axis</a></span>(<span class="dv">1</span>, <span class="dt">at =</span> b2<span class="op">$</span>M_YEAR)</a>
<a class="sourceLine" id="cb16-14" data-line-number="14"></a>
<a class="sourceLine" id="cb16-15" data-line-number="15"><span class="kw"><a href="https://rdrr.io/r/graphics/points.html">points</a></span>(b2[<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(LCI),], <span class="dt">type =</span> <span class="st">'l'</span>, <span class="dt">lty=</span><span class="dv">2</span>, <span class="dt">col=</span><span class="st">"grey70"</span>)</a>
<a class="sourceLine" id="cb16-16" data-line-number="16"><span class="kw"><a href="https://rdrr.io/r/graphics/points.html">points</a></span>(b2, <span class="dt">type =</span> <span class="st">'l'</span>, <span class="dt">lwd=</span><span class="fl">1.3</span>, <span class="dt">col =</span> col_pal[<span class="dv">1</span>])</a>
<a class="sourceLine" id="cb16-17" data-line-number="17"><span class="kw"><a href="https://rdrr.io/r/graphics/points.html">points</a></span>(b2[<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(LCI),], <span class="dt">col=</span> col_pal[<span class="dv">1</span>], <span class="dt">pch=</span><span class="dv">19</span>)</a>
<a class="sourceLine" id="cb16-18" data-line-number="18"><span class="kw"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="dt">h=</span><span class="dv">2</span>, <span class="dt">lty=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb16-19" data-line-number="19"></a>
<a class="sourceLine" id="cb16-20" data-line-number="20"><span class="cf">if</span> (<span class="kw"><a href="https://rdrr.io/r/base/class.html">class</a></span>(lm_mod)[<span class="dv">1</span>] <span class="op">!=</span><span class="st"> "try-error"</span>){</a>
<a class="sourceLine" id="cb16-21" data-line-number="21">    <span class="kw"><a href="https://rdrr.io/r/graphics/points.html">points</a></span>(b2<span class="op">$</span>M_YEAR, <span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(lm_mod, <span class="dt">newdata =</span> b2, <span class="dt">type =</span> <span class="st">"response"</span>)),</a>
<a class="sourceLine" id="cb16-22" data-line-number="22">    <span class="dt">type =</span> <span class="st">'l'</span>, <span class="dt">col=</span><span class="st">'maroon4'</span>, <span class="dt">lwd =</span> <span class="fl">1.5</span>, <span class="dt">lty =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb16-23" data-line-number="23">  }</a></code></pre></div>
<div class="figure">
<img src="Get_Started_2_files/figure-html/ind_fig-1.png" alt="Collated index." width="700"><p class="caption">
Collated index.
</p>
</div>
</div>
<div id="bootstrap-confidence-interval" class="section level5">
<h5 class="hasAnchor">
<a href="#bootstrap-confidence-interval" class="anchor"></a>6 Bootstrap confidence interval</h5>
<p>Confidence interval around the collated indices can be computed by a bootstrap method, where <em>n</em> site indices are randomly resampled <em>k</em> time to produce a distribution of annual collated indices from which confidence interval can be derived.</p>
<p>First we build define <em>k</em> bootstrap sample, with replacement, with the function <code><a href="../reference/boot_sample.html">boot_sample()</a></code>, here we will set 200 samples, but for reliable confidence interval, this number should be set to 1000.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">bootsample &lt;-<span class="st"> </span>rbms<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/rbms/man/boot_sample.html">boot_sample</a></span>(sindex, <span class="dt">boot_n =</span> <span class="dv">200</span>)</a></code></pre></div>
<p>Using the <code><a href="../reference/collated_index.html">collated_index()</a></code> function in a loop, with bootstrap sample to inform the argument <code>boot_ind</code>, we can produce <em>k</em> collated index for each year.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">co_index &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>()</a>
<a class="sourceLine" id="cb18-2" data-line-number="2"></a>
<a class="sourceLine" id="cb18-3" data-line-number="3"><span class="co">## for progression bar, uncomment the following</span></a>
<a class="sourceLine" id="cb18-4" data-line-number="4"><span class="co">## pb &lt;- txtProgressBar(min = 0, max = dim(bootsample$boot_ind)[1], initial = 0, char = "*",  style = 3)</span></a>
<a class="sourceLine" id="cb18-5" data-line-number="5"></a>
<a class="sourceLine" id="cb18-6" data-line-number="6"><span class="cf">for</span>(i <span class="cf">in</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(bootsample<span class="op">$</span>boot_ind)[<span class="dv">1</span>]))){</a>
<a class="sourceLine" id="cb18-7" data-line-number="7"></a>
<a class="sourceLine" id="cb18-8" data-line-number="8"> co_index[[i<span class="op">+</span><span class="dv">1</span>]] &lt;-<span class="st"> </span>rbms<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/rbms/man/collated_index.html">collated_index</a></span>(<span class="dt">data =</span> sindex, <span class="dt">s_sp =</span> <span class="dv">2</span>, <span class="dt">sindex_value =</span> <span class="st">"SINDEX"</span>, <span class="dt">bootID=</span>i, <span class="dt">boot_ind=</span> bootsample, <span class="dt">glm_weights=</span><span class="ot">TRUE</span>, <span class="dt">rm_zero=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb18-9" data-line-number="9"></a>
<a class="sourceLine" id="cb18-10" data-line-number="10"><span class="co">## for progression bar, uncomment the following</span></a>
<a class="sourceLine" id="cb18-11" data-line-number="11"><span class="co">## setTxtProgressBar(pb, i)</span></a>
<a class="sourceLine" id="cb18-12" data-line-number="12"></a>
<a class="sourceLine" id="cb18-13" data-line-number="13">}</a>
<a class="sourceLine" id="cb18-14" data-line-number="14"></a>
<a class="sourceLine" id="cb18-15" data-line-number="15"><span class="co">## collate and append all the result in a data.table format</span></a>
<a class="sourceLine" id="cb18-16" data-line-number="16">co_index &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/rbindlist.html">rbindlist</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(co_index, <span class="dt">FUN =</span> <span class="st">"[["</span>,<span class="st">"col_index"</span>))</a></code></pre></div>
<p>Annual log indices and the average are then computed from the original sample. Similarly, annual log indices are then computed for each bootstrap sample.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1">co_index_b &lt;-<span class="st"> </span>co_index[COL_INDEX <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.0001</span> <span class="op">&amp;</span><span class="st"> </span>COL_INDEX <span class="op">&lt;</span><span class="st"> </span><span class="dv">100000</span>, ]</a>
<a class="sourceLine" id="cb19-2" data-line-number="2">co_index_logInd &lt;-<span class="st"> </span>co_index_b[BOOTi <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, .(M_YEAR, COL_INDEX)][, <span class="kw"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(COL_INDEX)<span class="op">/</span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="dv">10</span>), by =<span class="st"> </span>M_YEAR][, mean_logInd <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(V1)]</a>
<a class="sourceLine" id="cb19-3" data-line-number="3"></a>
<a class="sourceLine" id="cb19-4" data-line-number="4"><span class="co">## merge the mean log index with the full bootstrap dataset</span></a>
<a class="sourceLine" id="cb19-5" data-line-number="5">data.table<span class="op">::</span><span class="kw">setnames</span>(co_index_logInd, <span class="st">"V1"</span>, <span class="st">"logInd"</span>); <span class="kw"><a href="https://rdrr.io/pkg/data.table/man/setkey.html">setkey</a></span>(co_index_logInd, M_YEAR); <span class="kw"><a href="https://rdrr.io/pkg/data.table/man/setkey.html">setkey</a></span>(co_index_b, M_YEAR)</a>
<a class="sourceLine" id="cb19-6" data-line-number="6">co_index_b &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/merge.html">merge</a></span>(co_index_b, co_index_logInd, <span class="dt">all.x =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb19-7" data-line-number="7"></a>
<a class="sourceLine" id="cb19-8" data-line-number="8">data.table<span class="op">::</span><span class="kw">setkey</span>(co_index_b, BOOTi, M_YEAR)</a>
<a class="sourceLine" id="cb19-9" data-line-number="9">co_index_b[ , boot_logInd <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(COL_INDEX)<span class="op">/</span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="dv">10</span>)]</a></code></pre></div>
<p>From the bootstrap sample, we can now derive a 95% Confidence Interval from the corresponding percentiles</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">b1 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/data.table.html">data.table</a></span>(<span class="dt">M_YEAR =</span> co_index_b<span class="op">$</span>M_YEAR, <span class="dt">LCI =</span> <span class="dv">2</span> <span class="op">+</span><span class="st"> </span>co_index_b<span class="op">$</span>boot_logInd <span class="op">-</span><span class="st"> </span>co_index_b<span class="op">$</span>mean_logInd)</a>
<a class="sourceLine" id="cb20-2" data-line-number="2">b2 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/data.table.html">data.table</a></span>(<span class="dt">M_YEAR =</span> co_index_b[BOOTi <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, M_YEAR], <span class="dt">LCI=</span> <span class="dv">2</span> <span class="op">+</span><span class="st"> </span>co_index_b[BOOTi <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, logInd] <span class="op">-</span><span class="st"> </span>co_index_b[BOOTi <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, mean_logInd])</a>
<a class="sourceLine" id="cb20-3" data-line-number="3">b5 &lt;-<span class="st"> </span>b1[co_index_b<span class="op">$</span>BOOTi <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>, <span class="kw"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(LCI, <span class="fl">0.025</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), by =<span class="st"> </span>M_YEAR]</a>
<a class="sourceLine" id="cb20-4" data-line-number="4">b6 &lt;-<span class="st"> </span>b1[co_index_b<span class="op">$</span>BOOTi <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>, <span class="kw"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(LCI, <span class="fl">0.975</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), by =<span class="st"> </span>M_YEAR]</a>
<a class="sourceLine" id="cb20-5" data-line-number="5">lm_mod &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(LCI <span class="op">~</span><span class="st"> </span>M_YEAR, <span class="dt">data =</span> b2), <span class="dt">silent=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb20-6" data-line-number="6"></a>
<a class="sourceLine" id="cb20-7" data-line-number="7"><span class="co">## define graph axis limits and color scheme</span></a>
<a class="sourceLine" id="cb20-8" data-line-number="8">yl &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Round.html">floor</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(b5<span class="op">$</span>V1, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)), <span class="kw"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(b6<span class="op">$</span>V1, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)))</a>
<a class="sourceLine" id="cb20-9" data-line-number="9"></a>
<a class="sourceLine" id="cb20-10" data-line-number="10">col_pal &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"cyan4"</span>, <span class="st">"orange"</span>, <span class="st">"orangered2"</span>)</a>
<a class="sourceLine" id="cb20-11" data-line-number="11"></a>
<a class="sourceLine" id="cb20-12" data-line-number="12"><span class="co">## draw the plot for the selected species</span></a>
<a class="sourceLine" id="cb20-13" data-line-number="13"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(b1, <span class="dt">ylim =</span> yl, <span class="dt">col =</span> <span class="kw"><a href="https://rdrr.io/r/grDevices/adjustcolor.html">adjustcolor</a></span>( <span class="st">"cyan4"</span>, <span class="dt">alpha.f =</span> <span class="fl">0.2</span>),</a>
<a class="sourceLine" id="cb20-14" data-line-number="14">      <span class="dt">xlab =</span> <span class="st">"year"</span>, <span class="dt">ylab =</span> <span class="kw"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="st">'log '</span>[<span class="st">'(10)'</span>]<span class="op">*</span><span class="st">' Collated Index'</span>),</a>
<a class="sourceLine" id="cb20-15" data-line-number="15">      <span class="dt">xaxt=</span><span class="st">"n"</span>, <span class="dt">type =</span> <span class="st">'n'</span>)</a>
<a class="sourceLine" id="cb20-16" data-line-number="16"></a>
<a class="sourceLine" id="cb20-17" data-line-number="17"><span class="kw"><a href="https://rdrr.io/r/graphics/axis.html">axis</a></span>(<span class="dv">1</span>, <span class="dt">at =</span> b2<span class="op">$</span>M_YEAR)</a>
<a class="sourceLine" id="cb20-18" data-line-number="18"></a>
<a class="sourceLine" id="cb20-19" data-line-number="19"><span class="kw"><a href="https://rdrr.io/r/graphics/segments.html">segments</a></span>(<span class="dt">x0 =</span> <span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(b5[,<span class="dv">1</span>])), <span class="dt">y0 =</span> <span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(b5[,<span class="dv">2</span>])),</a>
<a class="sourceLine" id="cb20-20" data-line-number="20">         <span class="dt">x1 =</span> <span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(b6[,<span class="dv">1</span>])), <span class="dt">y1 =</span> <span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(b6[,<span class="dv">2</span>])),</a>
<a class="sourceLine" id="cb20-21" data-line-number="21">         <span class="dt">col =</span> col_pal[<span class="dv">2</span>], <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb20-22" data-line-number="22"><span class="kw"><a href="https://rdrr.io/r/graphics/points.html">points</a></span>(b2[<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(LCI),], <span class="dt">type =</span> <span class="st">'l'</span>, <span class="dt">lty=</span><span class="dv">2</span>, <span class="dt">col=</span><span class="st">"grey70"</span>)</a>
<a class="sourceLine" id="cb20-23" data-line-number="23"><span class="kw"><a href="https://rdrr.io/r/graphics/points.html">points</a></span>(b2, <span class="dt">type =</span> <span class="st">'l'</span>, <span class="dt">lwd=</span><span class="fl">1.3</span>, <span class="dt">col =</span> col_pal[<span class="dv">1</span>])</a>
<a class="sourceLine" id="cb20-24" data-line-number="24"><span class="kw"><a href="https://rdrr.io/r/graphics/points.html">points</a></span>(b2[<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(LCI),], <span class="dt">col=</span> col_pal[<span class="dv">1</span>], <span class="dt">pch=</span><span class="dv">19</span>)</a>
<a class="sourceLine" id="cb20-25" data-line-number="25"><span class="kw"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="dt">h=</span><span class="dv">2</span>, <span class="dt">lty=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb20-26" data-line-number="26"></a>
<a class="sourceLine" id="cb20-27" data-line-number="27"><span class="cf">if</span> (<span class="kw"><a href="https://rdrr.io/r/base/class.html">class</a></span>(lm_mod)[<span class="dv">1</span>] <span class="op">!=</span><span class="st"> "try-error"</span>){</a>
<a class="sourceLine" id="cb20-28" data-line-number="28">    <span class="kw"><a href="https://rdrr.io/r/graphics/points.html">points</a></span>(b2<span class="op">$</span>M_YEAR, <span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(lm_mod, <span class="dt">newdata =</span> b2, <span class="dt">type =</span> <span class="st">"response"</span>)),</a>
<a class="sourceLine" id="cb20-29" data-line-number="29">    <span class="dt">type =</span> <span class="st">'l'</span>, <span class="dt">col=</span><span class="st">'maroon4'</span>, <span class="dt">lwd =</span> <span class="fl">1.5</span>, <span class="dt">lty =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb20-30" data-line-number="30">  }</a></code></pre></div>
<div class="figure">
<img src="Get_Started_2_files/figure-html/ind_fig_CI-1.png" alt="Collated index with 95% CI." width="700"><p class="caption">
Collated index with 95% CI.
</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Reto Schmucki, Colin A. Harrower.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
