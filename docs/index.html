<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Compute abundance index Butterfly Monitoring Schemes and flight curves, using the Generalize Abundance Index, using the spline approach. • rbms</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Compute abundance index Butterfly Monitoring Schemes and flight curves, using the Generalize Abundance Index, using the spline approach.">
<meta property="og:description" content="Implementation of the Generalize Abundance Index using the Spline method presented in Dennis et al. 2016, an adaptation of the two-stage model developed by Dennis et al. 2013 and extended in Schmucki et al. 2017. This package compute the flight curve from a set of monitoring sites and compute the abundance index, using the flight curve to impute values where weekly counts are missing. This is a fully revised version of the former RegionalGAM package. The rbms package has been totally rewritten and build on a more robust and efficient programming framework, providing more functionality and flexibility to the end-user.">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">rbms</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">
<div id="rbms" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#rbms" class="anchor"></a>rbms</h1></div>

<div id="a-new-package-that-replaces-the-former-regionalgam--" class="section level3">
<h3 class="hasAnchor">
<a href="#a-new-package-that-replaces-the-former-regionalgam--" class="anchor"></a>- A new package that replaces the former ‘regionalGAM’ -</h3>
<p>With the rapid expansion of monitoring efforts and the usefulness of conducting integrative analyses to inform conservation initiatives, the choice of a robust abundance index is crucial to adequately assess the species status. Butterfly Monitoring Schemes (BMS) operate in increasing number of countries with broadly the same methodology, yet they differ in their observation frequencies and often in the method used to compute annual abundance indices.</p>
<p>Here we implemented the method for computing an abundance index with the <em>regional GAM</em> approach, an extension of the two-stages model introduced by <a href="http://onlinelibrary.wiley.com/doi/10.1111/2041-210X.12053/abstract">Dennis et al. (2013)</a>. This index offers the best performance for a wide range of sampling frequency, providing greater robustness and unbiased estimates compared to the popular linear interpolation approach <a href="http://onlinelibrary.wiley.com/doi/10.1111/1365-2664.12561/abstract">(Schmucki et al. 2015)</a>.</p>
<div id="suggested-citation" class="section level4">
<h4 class="hasAnchor">
<a href="#suggested-citation" class="anchor"></a>Suggested citation</h4>
<p>Schmucki R., Harrower C. Dennis E. (2019) rbms: Computing genaralized abundance indices for butterfly monitoring count data. R package version 1.0.0. <a href="https://github.com/RetoSchmucki/rbms" class="uri">https://github.com/RetoSchmucki/rbms</a></p>
</div>
<div id="installation" class="section level4">
<h4 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h4>
<p>To install this package from GitHub, you will first need to install the package <code>devtools</code> that is available from CRAN. From there, simply use the the function <code>install_github()</code> to install the <code>rbms</code> package on your system. Note that this package was build with R 3.4.2, so you might have to update your R installation. If you are unable to install this package, you might consider sourcing the R script that can be found here: [rbms source code] (<a href="https://github.com/RetoSchmucki/rbms/blob/master/R/" class="uri">https://github.com/RetoSchmucki/rbms/blob/master/R/</a>)</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="cf">if</span>(<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span>(<span class="st">"devtools"</span>)) <span class="kw"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span>(<span class="st">"devtools"</span>)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">devtools<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/devtools/man/remote-reexports.html">install_github</a></span>(<span class="st">"RetoSchmucki/rbms"</span>)</a></code></pre></div>
<blockquote>
<p>LINUX note: You might have to install to following library to install the <code>sf package</code>.</p>
<pre><code>sudo apt-get install libudunits2-dev</code></pre>
</blockquote>
</div>
<div id="usage-example" class="section level4">
<h4 class="hasAnchor">
<a href="#usage-example" class="anchor"></a>Usage example</h4>
<div id="load-package-and-data-included-in-the-package" class="section level5">
<h5 class="hasAnchor">
<a href="#load-package-and-data-included-in-the-package" class="anchor"></a>1. load package and data included in the package</h5>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(rbms)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(m_visit)</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(m_count)</a></code></pre></div>
</div>
<div id="organize-the-data-to-cover-the-time-period-and-monitoring-season-of-the-bms" class="section level5">
<h5 class="hasAnchor">
<a href="#organize-the-data-to-cover-the-time-period-and-monitoring-season-of-the-bms" class="anchor"></a>2. organize the data to cover the time period and monitoring season of the BMS</h5>
<p>This create a full time series for the period of interest with days and weeks</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">ts_date &lt;-<span class="st"> </span><span class="kw"><a href="reference/ts_dwmy_table.html">ts_dwmy_table</a></span>(<span class="dt">InitYear =</span> <span class="dv">2000</span>, <span class="dt">LastYear =</span> <span class="dv">2003</span>, <span class="dt">WeekDay1 =</span> <span class="st">'monday'</span>)</a></code></pre></div>
<p>You can then define use the time-series to define your monitoring season with the StartMonth and EndMonth arguments. You can refine this with more arguments (e.g. StartDay, AnchorLength, and so on).</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">ts_season &lt;-<span class="st"> </span><span class="kw"><a href="reference/ts_monit_season.html">ts_monit_season</a></span>(ts_date, <span class="dt">StartMonth =</span> <span class="dv">4</span>, <span class="dt">EndMonth =</span> <span class="dv">9</span>, <span class="dt">StartDay =</span> <span class="dv">1</span>, <span class="dt">EndDay =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">                      <span class="dt">CompltSeason =</span> <span class="ot">TRUE</span>, <span class="dt">Anchor =</span> <span class="ot">TRUE</span>, <span class="dt">AnchorLength =</span> <span class="dv">7</span>, <span class="dt">AnchorLag =</span> <span class="dv">7</span>)</a></code></pre></div>
<p>Now that you have defined the monitoring season for the period of interest, you can add your data, starting with the visit date to inform about the sites and the visits</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">ts_season_visit &lt;-<span class="st"> </span><span class="kw"><a href="reference/ts_monit_site.html">ts_monit_site</a></span>(m_visit, ts_season)</a></code></pre></div>
<p>Once the visit data have been integrated, you can add the count for the species of interest, here we use the count data provided with the package for species “2”.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">ts_season_count &lt;-<span class="st"> </span><span class="kw"><a href="reference/ts_monit_count_site.html">ts_monit_count_site</a></span>(ts_season_visit, m_count, <span class="dt">sp =</span> <span class="dv">2</span>)</a></code></pre></div>
</div>
<div id="compute-the-yearly-flight-curve-for-the-data-you-just-created" class="section level5">
<h5 class="hasAnchor">
<a href="#compute-the-yearly-flight-curve-for-the-data-you-just-created" class="anchor"></a>3. Compute the yearly flight curve for the data you just created</h5>
<p>So far, I have only implemented the regionalGAM method. Here you can filter for the data used in your model by setting the Minimum number of visit, the minimum number of occurrence and number of site. It is important to remember that the resulting flight curve will depend on the quality of information provided to the model. In other words, “garbage in, garbage out”. If you have only occurrence, sites, and few visits, you might have an issue to get a reliable flight curve.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"> ts_flight_curve &lt;-<span class="st"> </span><span class="kw"><a href="reference/flight_curve.html">flight_curve</a></span>(ts_season_count, <span class="dt">NbrSample =</span> <span class="dv">200</span>, <span class="dt">MinVisit =</span> <span class="dv">5</span>, <span class="dt">MinOccur =</span> <span class="dv">3</span>, <span class="dt">MinNbrSite =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">                            <span class="dt">MaxTrial =</span> <span class="dv">3</span>, <span class="dt">FcMethod =</span> <span class="st">'regionalGAM'</span>, <span class="dt">GamFamily =</span> <span class="st">'nb'</span>, <span class="dt">SpeedGam =</span> <span class="ot">FALSE</span>, <span class="dt">CompltSeason =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p>The output of the flight_curve() function is a list of 3 objects, the phenology, the GAM model, and the data used to fit the GAM. Each of these object can be accessed by specifying the name within the list (e.g. ts_flight_curve$pheno). So for example, you can produce a simple plot for the flight curves with the following script.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"></a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(ts_flight_curve<span class="op">$</span>pheno[M_YEAR <span class="op">==</span><span class="st"> </span><span class="dv">2000</span>, trimDAYNO], ts_flight_curve<span class="op">$</span>pheno[M_YEAR <span class="op">==</span><span class="st"> </span><span class="dv">2000</span>, NM], <span class="dt">type =</span> <span class="st">'l'</span>,</a>
<a class="sourceLine" id="cb9-3" data-line-number="3">      <span class="dt">ylim =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>, <span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(ts_flight_curve<span class="op">$</span>pheno[, NM])), <span class="dt">xlab =</span> <span class="st">'Monitoring Year Day'</span>, <span class="dt">ylab =</span> <span class="st">'Relative Abundance'</span>)</a>
<a class="sourceLine" id="cb9-4" data-line-number="4">c &lt;-<span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="cf">for</span>(y <span class="cf">in</span> <span class="dv">2001</span><span class="op">:</span><span class="dv">2003</span>){</a>
<a class="sourceLine" id="cb9-6" data-line-number="6">  <span class="kw"><a href="https://rdrr.io/r/graphics/points.html">points</a></span>(ts_flight_curve<span class="op">$</span>pheno[M_YEAR <span class="op">==</span><span class="st"> </span>y, trimDAYNO], ts_flight_curve<span class="op">$</span>pheno[M_YEAR <span class="op">==</span><span class="st"> </span>y, NM], <span class="dt">type =</span> <span class="st">'l'</span>, <span class="dt">col =</span> c)</a>
<a class="sourceLine" id="cb9-7" data-line-number="7">  c &lt;-<span class="st"> </span>c <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb9-9" data-line-number="9"><span class="kw"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span>(<span class="st">'topright'</span>, <span class="dt">legend =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">2000</span><span class="op">:</span><span class="dv">2003</span>), <span class="dt">col =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">2000</span><span class="op">:</span><span class="dv">2003</span>))), <span class="dt">lty =</span> <span class="dv">1</span>, <span class="dt">bty =</span> <span class="st">'n'</span>)</a></code></pre></div>
</div>
<div id="impute-predicted-counts-for-missing-monitoring-dates" class="section level5">
<h5 class="hasAnchor">
<a href="#impute-predicted-counts-for-missing-monitoring-dates" class="anchor"></a>4. Impute predicted counts for missing monitoring dates</h5>
<p>Using the shape of the flight curve computed in 3, you can now impute expected counts for each site, using a GLM with the site, the observations and the phenology as predictors of daily counts. This is done with the impute_count function, using the count data (ts_season_count) and the calculated flight curve (ts_flight_curve$pheno).</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">site_year_sp_count &lt;-<span class="st"> </span><span class="kw"><a href="reference/impute_count.html">impute_count</a></span>(ts_season_count, ts_flight_curve<span class="op">$</span>pheno, <span class="dt">FamilyGlm =</span> <span class="st">'quasipoisson'</span>)</a></code></pre></div>
<p>The output is again a list of object, including the imputed counts and the model used. To access and visualize the imputed data, you can use the object “site_year_sp_count$impute_count”.</p>
<p>For example, you can plot the imputed and observed counts for a specific site (e.g. 2) and a year (e.g. 2003).</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">s &lt;-<span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2">y &lt;-<span class="st"> </span><span class="dv">2003</span></a>
<a class="sourceLine" id="cb11-3" data-line-number="3"></a>
<a class="sourceLine" id="cb11-4" data-line-number="4"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(site_year_sp_count<span class="op">$</span>impute_count[SITE_ID <span class="op">==</span><span class="st"> </span>s <span class="op">&amp;</span><span class="st"> </span>M_YEAR <span class="op">==</span><span class="st"> </span>y, DATE], site_year_sp_count<span class="op">$</span>impute_count[SITE_ID <span class="op">==</span><span class="st"> </span>s <span class="op">&amp;</span><span class="st"> </span>M_YEAR <span class="op">==</span><span class="st"> </span>y, FITTED],</a>
<a class="sourceLine" id="cb11-5" data-line-number="5">    <span class="dt">ylim=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>, <span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(site_year_sp_count<span class="op">$</span>impute_count[SITE_ID <span class="op">==</span><span class="st"> </span>s <span class="op">&amp;</span><span class="st"> </span>M_YEAR <span class="op">==</span><span class="st"> </span>y, COUNT_IMPUTED])),</a>
<a class="sourceLine" id="cb11-6" data-line-number="6">    <span class="dt">col =</span> <span class="st">'blue'</span>, <span class="dt">type=</span><span class="st">'l'</span>,</a>
<a class="sourceLine" id="cb11-7" data-line-number="7">    <span class="dt">main =</span> <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">'Site '</span>, s, <span class="st">', Season '</span>, y),</a>
<a class="sourceLine" id="cb11-8" data-line-number="8">    <span class="dt">xlab=</span><span class="st">'Monitoring Month'</span>, <span class="dt">ylab=</span><span class="st">'Fitted Count'</span>)</a>
<a class="sourceLine" id="cb11-9" data-line-number="9"><span class="kw"><a href="https://rdrr.io/r/graphics/points.html">points</a></span>(site_year_sp_count<span class="op">$</span>impute_count[SITE_ID <span class="op">==</span><span class="st"> </span>s <span class="op">&amp;</span><span class="st"> </span>M_YEAR <span class="op">==</span><span class="st"> </span>y, DATE], site_year_sp_count<span class="op">$</span>impute_count[SITE_ID <span class="op">==</span><span class="st"> </span>s <span class="op">&amp;</span><span class="st"> </span>M_YEAR <span class="op">==</span><span class="st"> </span>y, COUNT],</a>
<a class="sourceLine" id="cb11-10" data-line-number="10">       <span class="dt">col=</span><span class="st">'red'</span>)</a></code></pre></div>
</div>
<div id="compute-annual-site-indices" class="section level5">
<h5 class="hasAnchor">
<a href="#compute-annual-site-indices" class="anchor"></a>5. Compute annual site indices</h5>
<p>The butterfly_day function compute the sum of weekly butterfly count, using the predicted count for every mid-week (day 4 - Thursday). The total annual count can also be computed by settign the WeekCount = FALSE, this result in using all daily count over the season. total re is no function implemented yet, but you can count the total of weekly butterfly count for each year and site, using one count a week during the defined monitoring period (e.g. Thursday - WEEK_DAY 4).</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">b_index &lt;-<span class="st"> </span><span class="kw">butterfly_day</span>(site_year_sp_count, <span class="dt">WeekCount =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<blockquote>
<p>This is how the total weekly butterfly count is computed this way (e.g. Thursday - WEEK_DAY 4).</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">week_count &lt;-<span class="st"> </span>site_year_sp_count<span class="op">$</span>impute_count[COMPLT_SEASON <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span>M_SEASON <span class="op">!=</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>WEEK_DAY <span class="op">==</span><span class="st"> </span><span class="dv">4</span>, FITTED, by =<span class="st"> </span>.(SITE_ID, M_YEAR, WEEK)]</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">site_total_week_count &lt;-<span class="st"> </span>site_year_sp_count<span class="op">$</span>impute_count[COMPLT_SEASON <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span>M_SEASON <span class="op">!=</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>WEEK_DAY <span class="op">==</span><span class="st"> </span><span class="dv">4</span>, FITTED, by =<span class="st"> </span>.(SITE_ID, M_YEAR, WEEK)][,<span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(FITTED), by =<span class="st"> </span>.(SITE_ID, M_YEAR)]</a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(site_total_week_count)</a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(week_count[SITE_ID <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span>M_YEAR <span class="op">==</span><span class="st"> </span><span class="dv">2000</span>, .(WEEK, FITTED)], <span class="dt">type=</span><span class="st">'l'</span>)</a>
<a class="sourceLine" id="cb13-5" data-line-number="5"><span class="kw"><a href="https://rdrr.io/r/graphics/points.html">points</a></span>(week_count[SITE_ID <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span>M_YEAR <span class="op">==</span><span class="st"> </span><span class="dv">2000</span>, .(WEEK, FITTED)], <span class="dt">col =</span> <span class="st">'red'</span>)</a></code></pre></div>
</blockquote>
</div>
<div id="compute-general-trend-using-a-collated-index" class="section level5">
<h5 class="hasAnchor">
<a href="#compute-general-trend-using-a-collated-index" class="anchor"></a>6. Compute general trend using a collated index</h5>
<blockquote>
<p>NOTE: this is just an example, you can also use the function available in the R package rtrim</p>
</blockquote>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(nlme)</a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(MASS)</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">b_index_df &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(b_index)</a>
<a class="sourceLine" id="cb14-4" data-line-number="4"><span class="co"># compute collated annual indices</span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5">glmm.mod_fullyear &lt;-<span class="st"> </span><span class="kw">glmmPQL</span>(BUTTERFLY_DAY <span class="op">~</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(M_YEAR) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">data =</span> b_index_df , <span class="dt">family =</span> quasipoisson, <span class="dt">random =</span> <span class="op">~</span><span class="dv">1</span><span class="op">|</span>SITE_ID,</a>
<a class="sourceLine" id="cb14-6" data-line-number="6">                          <span class="dt">correlation =</span> <span class="kw">corAR1</span>(<span class="dt">form =</span><span class="op">~</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(M_YEAR)<span class="op">|</span>SITE_ID), <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb14-7" data-line-number="7"><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(glmm.mod_fullyear)</a>
<a class="sourceLine" id="cb14-8" data-line-number="8"></a>
<a class="sourceLine" id="cb14-9" data-line-number="9"><span class="co"># extract collated index and plot against years</span></a>
<a class="sourceLine" id="cb14-10" data-line-number="10">col.index &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(glmm.mod_fullyear<span class="op">$</span>coefficients<span class="op">$</span>fixed)</a>
<a class="sourceLine" id="cb14-11" data-line-number="11">year &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(b_index_df<span class="op">$</span>M_YEAR)</a>
<a class="sourceLine" id="cb14-12" data-line-number="12"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(year, col.index, <span class="dt">type =</span> <span class="st">'o'</span>, <span class="dt">xlab =</span> <span class="st">"year"</span>, <span class="dt">ylab =</span> <span class="st">"collated index"</span>)</a></code></pre></div>
<p>From the collated indices, you can now compute a temporal trend for that species in this region. Here we first use a simple linear model and explore for temporal autocorrelation that we will account in our final model.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="co"># model temporal trend with a simple linear regression</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2">mod1 &lt;-<span class="st"> </span><span class="kw">gls</span>(col.index <span class="op">~</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(year))</a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(mod1)</a>
<a class="sourceLine" id="cb15-4" data-line-number="4"></a>
<a class="sourceLine" id="cb15-5" data-line-number="5"><span class="co"># check for temporal autocorrelation in the residuals</span></a>
<a class="sourceLine" id="cb15-6" data-line-number="6"><span class="kw"><a href="https://rdrr.io/r/stats/acf.html">acf</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(mod1, <span class="dt">type =</span> <span class="st">"normalized"</span>))</a>
<a class="sourceLine" id="cb15-7" data-line-number="7"></a>
<a class="sourceLine" id="cb15-8" data-line-number="8"><span class="co"># adjust the model to account for autocorrelation in the residuals</span></a>
<a class="sourceLine" id="cb15-9" data-line-number="9">mod2 &lt;-<span class="st"> </span><span class="kw">gls</span>(col.index <span class="op">~</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(year), <span class="dt">correlation =</span> <span class="kw">corARMA</span>(<span class="dt">p =</span> <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb15-10" data-line-number="10"><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(mod2)</a>
<a class="sourceLine" id="cb15-11" data-line-number="11"></a>
<a class="sourceLine" id="cb15-12" data-line-number="12"><span class="co"># check for remaining autocorrelation in the residuals</span></a>
<a class="sourceLine" id="cb15-13" data-line-number="13"><span class="kw"><a href="https://rdrr.io/r/stats/acf.html">acf</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(mod2, <span class="dt">type =</span> <span class="st">"normalized"</span>))</a>
<a class="sourceLine" id="cb15-14" data-line-number="14"></a>
<a class="sourceLine" id="cb15-15" data-line-number="15"><span class="co"># plot abundance with trend line</span></a>
<a class="sourceLine" id="cb15-16" data-line-number="16"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(year, col.index, <span class="dt">type=</span><span class="st">'o'</span>, <span class="dt">xlab =</span> <span class="st">"year"</span>, <span class="dt">ylab =</span> <span class="st">"collated index"</span>)</a>
<a class="sourceLine" id="cb15-17" data-line-number="17"><span class="kw"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(mod1, <span class="dt">lty =</span> <span class="dv">2</span>, <span class="dt">col =</span> <span class="st">"red"</span>)</a>
<a class="sourceLine" id="cb15-18" data-line-number="18"><span class="kw"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(mod2, <span class="dt">lty =</span> <span class="dv">2</span>, <span class="dt">col =</span> <span class="st">"blue"</span>)</a></code></pre></div>
</div>
<div id="reporting-issues" class="section level5">
<h5 class="hasAnchor">
<a href="#reporting-issues" class="anchor"></a>Reporting Issues</h5>
<p>For reporting errors and issues related to this package and its functions, please open a <a href="https://github.com/RetoSchmucki/rbms/issues">issue here</a></p>
</div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
    <div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a>.md</small></li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>Reto Schmucki <br><small class="roles"> Author, maintainer </small>  </li>
<li>Colin A. Harrower <br><small class="roles"> Author </small>  </li>
<li><a href="authors.html">All authors...</a></li>
</ul>
</div>

  <div class="dev-status">
<h2>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://travis-ci.org/RetoSchmucki/rbms"><img src="https://travis-ci.org/RetoSchmucki/rbms.png?branch=master" alt="Build Status"></a></li>
</ul>
</div>
</div>
</div>


      <footer><div class="copyright">
  <p>Developed by Reto Schmucki, Colin A. Harrower.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
